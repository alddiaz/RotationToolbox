function [ R1, R2, R3, R4 ] = dRTdq(q)
%% The derivative of R'(q) w.r.t. qk, k={1,2,3,4}
%
% Aldo Diaz, University of Campinas, 2020

% if norm(q) ~= 1 % 'q' is a non-unit quaternion
% 
%     R1 = 2* [               2*q(1)*(q(3)^2+q(4)^2)                  -q(4)*(q(2)^2+q(3)^2+q(4)^2-q(1)^2)-2*q(1)*q(2)*q(3)   q(3)*(q(2)^2+q(3)^2+q(4)^2-q(1)^2)-2*q(1)*q(2)*q(4);
%                q(4)*(q(2)^2+q(3)^2+q(4)^2-q(1)^2)-2*q(1)*q(2)*q(3)               2*q(1)*(q(2)^2+q(4)^2)                   -q(2)*(q(2)^2+q(3)^2+q(4)^2-q(1)^2)-2*q(1)*q(3)*q(4);
%               -q(3)*(q(2)^2+q(3)^2+q(4)^2-q(1)^2)-2*q(1)*q(2)*q(4)   q(2)*(q(2)^2+q(3)^2+q(4)^2-q(1)^2)-2*q(1)*q(3)*q(4)                   2*q(1)*(q(2)^2+q(3)^2)              ]/((q(1)^2+q(2)^2+q(3)^2+q(4)^2)^2);
% 
%     R2 = 2* [               2*q(2)*(q(3)^2+q(4)^2)                   q(3)*(q(1)^2-q(2)^2+q(3)^2+q(4)^2)+2*q(1)*q(2)*q(4)   q(4)*(q(1)^2-q(2)^2+q(3)^2+q(4)^2)-2*q(1)*q(2)*q(3);
%                q(3)*(q(1)^2-q(2)^2+q(3)^2+q(4)^2)-2*q(1)*q(2)*q(4)               -2*q(2)*(q(1)^2+q(3)^2)                  -q(1)*(q(1)^2-q(2)^2+q(3)^2+q(4)^2)-2*q(2)*q(3)*q(4);
%                q(4)*(q(1)^2-q(2)^2+q(3)^2+q(4)^2)+2*q(1)*q(2)*q(3)   q(1)*(q(1)^2-q(2)^2+q(3)^2+q(4)^2)-2*q(2)*q(3)*q(4)                  -2*q(2)*(q(1)^2+q(4)^2)              ]/((q(1)^2+q(2)^2+q(3)^2+q(4)^2)^2);
% 
%     R3 = 2* [              -2*q(3)*(q(1)^2+q(2)^2)                   q(2)*(q(1)^2+q(2)^2-q(3)^2+q(4)^2)+2*q(1)*q(3)*q(4)   q(1)*(q(1)^2+q(2)^2-q(3)^2+q(4)^2)-2*q(2)*q(3)*q(4);
%                q(2)*(q(1)^2+q(2)^2-q(3)^2+q(4)^2)-2*q(1)*q(3)*q(4)                2*q(3)*(q(2)^2+q(4)^2)                   q(4)*(q(1)^2+q(2)^2-q(3)^2+q(4)^2)+2*q(1)*q(2)*q(3);
%               -q(1)*(q(1)^2+q(2)^2-q(3)^2+q(4)^2)-2*q(2)*q(3)*q(4)   q(4)*(q(1)^2+q(2)^2-q(3)^2+q(4)^2)-2*q(1)*q(2)*q(3)                  -2*q(3)*(q(1)^2+q(4)^2)              ]/((q(1)^2+q(2)^2+q(3)^2+q(4)^2)^2);
% 
%     R4 = 2* [              -2*q(4)*(q(1)^2+q(2)^2)                  -q(1)*(q(1)^2+q(2)^2+q(3)^2-q(4)^2)-2*q(2)*q(3)*q(4)   q(2)*(q(1)^2+q(2)^2+q(3)^2-q(4)^2)-2*q(1)*q(3)*q(4);
%                q(1)*(q(1)^2+q(2)^2+q(3)^2-q(4)^2)-2*q(2)*q(3)*q(4)              -2*q(4)*(q(1)^2+q(3)^2)                    q(3)*(q(1)^2+q(2)^2+q(3)^2-q(4)^2)+2*q(1)*q(2)*q(4);
%                q(2)*(q(1)^2+q(2)^2+q(3)^2-q(4)^2)+2*q(1)*q(3)*q(4)   q(3)*(q(1)^2+q(2)^2+q(3)^2-q(4)^2)-2*q(1)*q(2)*q(4)                   2*q(4)*(q(2)^2+q(3)^2)              ]/((q(1)^2+q(2)^2+q(3)^2+q(4)^2)^2);
% 
% else % 'q' is a unit quaternion
% 
    R1 = 2* [  q(1)   -q(4)   q(3);
               q(4)    q(1)  -q(2);
              -q(3)    q(2)   q(1) ];

    R2 = 2* [  q(2)    q(3)   q(4);
               q(3)   -q(2)  -q(1);
               q(4)    q(1)  -q(2) ];

    R3 = 2* [ -q(3)    q(2)   q(1);
               q(2)    q(3)   q(4);
              -q(1)    q(4)  -q(3) ];

    R4 = 2* [ -q(4)   -q(1)   q(2);
               q(1)   -q(4)   q(3);
               q(2)    q(3)   q(4) ];
% 
% end

end
